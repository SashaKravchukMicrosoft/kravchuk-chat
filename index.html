<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Family Video Chat</title>
<style>
body{font-family:sans-serif;text-align:center;background:#111;color:#fff;}
video{width:45%;margin:10px;background:#000;border-radius:12px;}
#status{margin:10px;}
</style>
</head>
<body>
<h2>Family Video Chat</h2>
<video id="localVideo" autoplay muted playsinline></video>
<video id="remoteVideo" autoplay playsinline></video>
<p id="status">Connecting...</p>

<script>
let pc, localStream;
const localVideo = document.getElementById('localVideo');
const remoteVideo = document.getElementById('remoteVideo');
const statusText = document.getElementById('status');

// Введите ваши номера для комнаты: мама и тётя
const myNumber = prompt("Введите ваш номер телефона");
const peerNumber = prompt("Введите номер другого участника");

// Base64-хэш для приватности
const ROOM = btoa(myNumber + "-" + peerNumber);

// Бесплатный публичный сигналинг WebSocket
const SIGNALING_SERVER = "wss://demo.piesocket.com/v3/channel_1?api_key=demo";

let ws;

function log(msg){ statusText.innerText = msg; }

async function startCamera(){
    localStream = await navigator.mediaDevices.getUserMedia({video:true,audio:true});
    localVideo.srcObject = localStream;
    log("Camera started");
}

function initPeer(){
    pc = new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]});
    pc.ontrack = e => remoteVideo.srcObject = e.streams[0];
    pc.onicecandidate = e => { if(e.candidate) ws.send(JSON.stringify({room:ROOM,candidate:e.candidate})); };
    localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));
}

async function start(){
    await startCamera();
    initPeer();

    ws = new WebSocket(SIGNALING_SERVER);
    ws.onmessage = async (msg)=>{
        let data = JSON.parse(msg.data);
        if(data.room!==ROOM) return;

        if(data.offer && !pc.remoteDescription){
            await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            ws.send(JSON.stringify({room:ROOM,answer:answer}));
            log("Connected! Peer answer sent.");
        } else if(data.answer && !pc.localDescription?.type.includes("answer")){
            await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
            log("Connected! Peer answer received.");
        } else if(data.candidate){
            try{ await pc.addIceCandidate(data.candidate); }catch(e){}
        }
    };

    ws.onopen = async ()=>{
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        ws.send(JSON.stringify({room:ROOM,offer:offer}));
        log("Waiting for peer to connect...");
    };
}

// Запускаем всё автоматически
start();
</script>
</body>
</html>