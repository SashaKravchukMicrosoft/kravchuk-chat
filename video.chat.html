<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Simple P2P Family Video</title>
<style>
body { font-family: sans-serif; text-align: center; background:#111; color:#fff; }
video { width: 45%; margin:10px; background:#000; border-radius:12px; }
button { padding:10px 20px; margin:10px; font-size:16px; border-radius:8px; }
textarea { width:90%; height:80px; }
</style>
</head>
<body>

<h2>Family P2P Video</h2>

<video id="localVideo" autoplay muted playsinline></video>
<video id="remoteVideo" autoplay playsinline></video>

<br>

<button id="startBtn">Start Camera</button>
<button id="createBtn">Create Link</button>
<button id="answerBtn">Generate Answer Link</button>

<p id="status"></p>

<script>
const localVideo = document.getElementById("localVideo");
const remoteVideo = document.getElementById("remoteVideo");
const statusText = document.getElementById("status");

let pc;
let localStream;

function log(msg){
  statusText.innerText = msg;
}

async function initPeer(){
  pc = new RTCPeerConnection({
    iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
  });

  pc.ontrack = e => {
    remoteVideo.srcObject = e.streams[0];
  };

  pc.oniceconnectionstatechange = () => {
    log("ICE state: " + pc.iceConnectionState);
  };

  localStream.getTracks().forEach(track =>
    pc.addTrack(track, localStream)
  );
}

async function startCamera(){
  localStream = await navigator.mediaDevices.getUserMedia({
    video: true,
    audio: true
  });
  localVideo.srcObject = localStream;
  log("Camera started");
}

async function waitForIceComplete(){
  return new Promise(resolve=>{
    if(pc.iceGatheringState === "complete"){
      resolve();
    } else {
      pc.onicegatheringstatechange = ()=>{
        if(pc.iceGatheringState === "complete"){
          resolve();
        }
      };
    }
  });
}

document.getElementById("startBtn").onclick = startCamera;

document.getElementById("createBtn").onclick = async ()=>{
  await initPeer();
  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  await waitForIceComplete();

  const encoded = btoa(JSON.stringify(pc.localDescription));
  const link = location.origin + location.pathname + "?offer=" + encoded;

  prompt("Send this link:", link);
  log("Offer link created");
};

document.getElementById("answerBtn").onclick = async ()=>{
  const params = new URLSearchParams(window.location.search);

  if(params.get("offer")){
    await initPeer();
    const offer = JSON.parse(atob(params.get("offer")));
    await pc.setRemoteDescription(offer);

    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);
    await waitForIceComplete();

    const encoded = btoa(JSON.stringify(pc.localDescription));
    const link = location.origin + location.pathname + "?answer=" + encoded;

    prompt("Send this answer link back:", link);
    log("Answer link created");
  }

  if(params.get("answer")){
    const answer = JSON.parse(atob(params.get("answer")));
    await pc.setRemoteDescription(answer);
    log("Connected!");
  }
};
</script>

</body>
</html>