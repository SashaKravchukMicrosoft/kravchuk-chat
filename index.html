<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>üå∂Ô∏è–ß–∏–ª–∏–ß–∞—Ç</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="description" content="P2P video chat application">
<!-- Disable caching as much as possible from the client side -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<style>
body{margin:0;font-family:sans-serif;background:#111;color:#fff;text-align:center;touch-action:manipulation;}
/* Generic hidden helper used by JS to hide controls */
.hidden{display:none !important}
video{width:100vw;height:100vh;object-fit:cover;background:#000;}
button{padding:10px 15px;font-size:16px;border-radius:6px;background:transparent;border:none;color:inherit}
#status{position:fixed;bottom:10px;width:100%;text-align:center;font-size:14px;}
/* controls container fixed; children flow inline */
#controls{position:fixed;top:10px;left:10px;display:flex;gap:8px;align-items:center;z-index:10000}
#switchCamBtn{background:transparent;border:1px solid rgba(255,255,255,0.5);color:#fff;cursor:pointer;padding:8px 10px;border-radius:6px}
#micToggle,#outputToggle,#hangupBtn,#refreshBtn{background:transparent;border:1px solid rgba(255,255,255,0.15);color:#fff;cursor:pointer;padding:8px;border-radius:6px}
#micSelect,#outputSelect{background:rgba(0,0,0,0.6);color:#fff;border:1px solid rgba(255,255,255,0.12);padding:6px;border-radius:6px}
#micSelect.hidden,#outputSelect.hidden,#roomSelect.hidden{display:none;position:relative}
#micSelect{min-width:180px}
#outputSelect{min-width:160px}
/* room selector */
#roomThumb{font-size:20px;display:inline-flex;align-items:center;justify-content:center;padding:6px;border-radius:6px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);cursor: pointer;}
#roomSelect{background:rgba(0,0,0,0.6);color:#fff;border:1px solid rgba(255,255,255,0.12);padding:6px;border-radius:6px;min-width:160px}
/* ===== SETUP SCREEN ===== */
#setupScreen{position:fixed;inset:0;z-index:20000;background:#111;display:flex;align-items:center;justify-content:center;}
.setup-inner{display:flex;flex-direction:column;align-items:center;gap:16px;padding:32px 24px;max-width:400px;width:100%;}
.setup-logo{font-size:64px;}
.setup-title{font-size:28px;margin:0;}
.setup-subtitle{font-size:15px;color:#aaa;margin:0;text-align:center;}
.setup-input{width:100%;box-sizing:border-box;padding:14px 16px;font-size:20px;background:#222;color:#fff;border:1px solid #444;border-radius:10px;text-align:center;outline:none;}
.setup-input:focus{border-color:#4caf50;}
.setup-btn{width:100%;padding:16px;font-size:18px;background:#4caf50;color:#fff;border:none;border-radius:10px;cursor:pointer;font-weight:bold;}
.setup-btn:active{background:#388e3c;}
/* ===== DIAL PAD SCREEN ===== */
#dialpadScreen{position:fixed;inset:0;z-index:19000;background:#111;display:flex;align-items:center;justify-content:center;}
.dialpad-inner{display:flex;flex-direction:column;align-items:center;gap:12px;padding:24px 16px;max-width:360px;width:100%;}
.dialpad-my-number{font-size:13px;color:#888;}
#dialpadMyNum{color:#ccc;margin-left:4px;}
.dialpad-contact-btn{background:#333;color:#fff;border:1px solid #555;border-radius:8px;padding:10px 20px;font-size:15px;cursor:pointer;width:100%;}
.dial-display{width:100%;min-height:60px;display:flex;align-items:center;justify-content:center;font-size:32px;letter-spacing:4px;color:#fff;background:#1a1a1a;border-radius:10px;border:1px solid #333;}
.dial-keys{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;width:100%;}
.dial-key{background:#222;color:#fff;border:1px solid #333;border-radius:10px;font-size:22px;padding:18px 0;cursor:pointer;display:flex;flex-direction:column;align-items:center;line-height:1;-webkit-tap-highlight-color:transparent;user-select:none;}
.dial-key sub{font-size:9px;color:#888;letter-spacing:1px;margin-top:2px;}
.dial-key:active{background:#333;}
.dialpad-actions{display:flex;gap:16px;align-items:center;justify-content:center;width:100%;margin-top:8px;}
.dialpad-action-btn{background:#222;color:#fff;border:1px solid #333;border-radius:50%;width:56px;height:56px;font-size:22px;cursor:pointer;display:flex;align-items:center;justify-content:center;}
.dialpad-call-btn{background:#4caf50;color:#fff;border:none;border-radius:50%;width:72px;height:72px;font-size:28px;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 20px rgba(76,175,80,0.4);}
.dialpad-call-btn:active{background:#388e3c;}
.dialpad-action-btn:active{background:#333;}
/* ===== DIAL PAD HEADER ===== */
.dialpad-header{display:flex;flex-direction:column;align-items:center;gap:2px;margin-bottom:8px;}
.dialpad-header-logo{font-size:44px;filter:drop-shadow(0 0 14px rgba(76,175,80,0.55));line-height:1;}
.dialpad-header-name{font-size:24px;font-weight:800;letter-spacing:3px;background:white;-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
.dialpad-header-num{font-size:12px;color:#555;letter-spacing:1px;min-height:16px;}
/* ===== BURGER BUTTON ===== */
.burger-btn{position:fixed;top:10px;right:10px;z-index:10001;background:transparent;border:1px solid rgba(255,255,255,0.15);color:#fff;cursor:pointer;padding:8px 12px;border-radius:6px;font-size:18px;}
/* ===== BURGER OVERLAY + PANEL ===== */
#burgerOverlay{position:fixed;inset:0;z-index:29000;background:rgba(0,0,0,0.5);}
.burger-panel{position:fixed;top:0;right:0;bottom:0;width:min(320px,85vw);z-index:30000;background:#1a1a1a;border-left:1px solid #333;transform:translateX(100%);transition:transform 0.25s ease;overflow-y:auto;}
.burger-panel.open{transform:translateX(0);}
.burger-panel-inner{display:flex;flex-direction:column;padding-bottom:24px;}
.burger-my-number-section{padding:20px 20px 16px;border-bottom:1px solid #333;}
.burger-section-label{font-size:12px;color:#888;text-transform:uppercase;letter-spacing:1px;padding:16px 20px 8px;}
.burger-my-number-row{display:flex;align-items:center;gap:12px;margin-top:4px;}
.burger-my-num-text{font-size:18px;color:#fff;flex:1;}
.burger-change-btn{font-size:13px;color:#4caf50;background:none;border:1px solid #4caf50;border-radius:6px;padding:6px 10px;cursor:pointer;}
.call-history-list{padding:0 12px;}
.history-entry{display:flex;align-items:center;gap:12px;padding:14px 8px;border-bottom:1px solid #2a2a2a;}
.history-info{flex:1;display:flex;flex-direction:column;gap:2px;min-width:0;}
.history-name{font-size:16px;color:#fff;cursor:pointer;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.history-name:hover{color:#4caf50;}
.history-date{font-size:12px;color:#888;}
.history-call-btn{background:none;border:1px solid #333;color:#fff;border-radius:50%;width:40px;height:40px;font-size:18px;cursor:pointer;flex-shrink:0;display:flex;align-items:center;justify-content:center;padding:0;}
.history-call-btn:active{background:#333;}
.history-del-btn{background:none;border:1px solid #333;color:#666;border-radius:50%;width:32px;height:32px;font-size:13px;cursor:pointer;flex-shrink:0;display:flex;align-items:center;justify-content:center;padding:0;}
.history-del-btn:hover{color:#e53935;border-color:#e53935;}
.history-del-btn:active{background:#1a0000;}
.burger-close-btn{margin:20px;background:#333;color:#fff;border:none;border-radius:8px;padding:14px;font-size:16px;cursor:pointer;}
/* ===== INCOMING CALL OVERLAY ===== */
#incomingCallOverlay{position:fixed;inset:0;z-index:50000;background:rgba(0,0,0,0.78);display:flex;align-items:center;justify-content:center;}
#incomingCallDialog{background:#1a1a1a;border:1px solid #2a2a2a;border-radius:20px;padding:36px 28px;max-width:340px;width:88%;display:flex;flex-direction:column;align-items:center;gap:14px;animation:callRing 1.2s ease-in-out infinite alternate;}
@keyframes callRing{from{box-shadow:0 0 0 0 rgba(76,175,80,0.5);}to{box-shadow:0 0 0 20px rgba(76,175,80,0);}}
#incomingCallIcon{font-size:52px;}
#incomingCallLabel{font-size:13px;color:#888;text-transform:uppercase;letter-spacing:1.5px;}
#incomingCallerName{font-size:26px;font-weight:bold;color:#fff;text-align:center;word-break:break-word;}
#incomingCallerNumber{font-size:15px;color:#aaa;}
#incomingCallActions{display:flex;gap:32px;margin-top:12px;}
#declineCallBtn{background:#e53935;color:#fff;border:none;border-radius:50%;width:72px;height:72px;font-size:30px;cursor:pointer;box-shadow:0 4px 16px rgba(229,57,53,0.4);}
#acceptCallBtn{background:#4caf50;color:#fff;border:none;border-radius:50%;width:72px;height:72px;font-size:30px;cursor:pointer;box-shadow:0 4px 16px rgba(76,175,80,0.4);}
#declineCallBtn:active{background:#b71c1c;}
#acceptCallBtn:active{background:#388e3c;}
</style>
</head>
<body>

<video id="remoteVideo" autoplay playsinline class="hidden"></video>
<div id="controls" class="hidden">
	<button id="switchCamBtn">üì∑</button>
	<button id="micToggle" title="–í—ã–±—Ä–∞—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω">üéôÔ∏è</button>
	<select id="micSelect" aria-label="–í—ã–±–æ—Ä –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞" class="hidden"></select>
	<button id="outputToggle" title="–í—ã–±—Ä–∞—Ç—å –≤—ã—Ö–æ–¥">üîä</button>
	<select id="outputSelect" aria-label="–í—ã–±–æ—Ä —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –≤—ã–≤–æ–¥–∞" class="hidden"></select>
	<span id="roomThumb">üè∑Ô∏è</span>
	<select id="roomSelect" aria-label="–í—ã–±–æ—Ä –∫–æ–º–Ω–∞—Ç—ã" class="hidden"></select>
	<button id="hangupBtn" title="–°–±—Ä–æ—Å–∏—Ç—å –∑–≤–æ–Ω–æ–∫">üìû</button>
	<button id="refreshBtn" title="–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É">üîÑ</button>
</div>
<p id="status" class="hidden">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</p>

<script>
// Try to stop service workers (if any) so they don't cache responses
if('serviceWorker' in navigator){
	navigator.serviceWorker.getRegistrations().then(regs=>regs.forEach(r=>r.unregister())).catch(()=>{});
}

// If the page is restored from bfcache, reload to get a fresh copy
window.addEventListener('pageshow', (e)=>{
	if(e.persisted) {
		const u = new URL(window.location.href);
		u.searchParams.set('_', Date.now());
		window.location.replace(u.toString());
	}
});

// Intercept F5 / Ctrl+R / Cmd+R and reload with cache-busting param
window.addEventListener('keydown', (e)=>{
	const isReload = e.key === 'F5' || ((e.ctrlKey||e.metaKey) && e.key.toLowerCase() === 'r');
	if(isReload){
		e.preventDefault();
		const u = new URL(window.location.href);
		u.searchParams.set('_', Date.now());
		window.location.href = u.toString();
	}
});
</script>
<!-- ===== PHONE SETUP SCREEN ===== -->
<div id="setupScreen">
  <div class="setup-inner">
    <div class="setup-logo">üå∂Ô∏è</div>
    <h1 class="setup-title">–ß–∏–ª–∏–ß–∞—Ç</h1>
    <p class="setup-subtitle">–£–∫–∞–∂–∏—Ç–µ –≤–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –¥–ª—è –∑–≤–æ–Ω–∫–æ–≤</p>
    <input type="tel" id="myPhoneInput" class="setup-input"
           placeholder="+7 (999) 123-45-67" autocomplete="tel"/>
    <button id="setupSubmitBtn" class="setup-btn">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å ‚Üí</button>
  </div>
</div>

<!-- ===== DIAL PAD SCREEN ===== -->
<div id="dialpadScreen" class="hidden">
  <div class="dialpad-inner">
    <div class="dialpad-header">
      <span class="dialpad-header-logo">üå∂Ô∏è</span>
      <span class="dialpad-header-name">–ß–∏–ª–∏–ß–∞—Ç</span>
      <span class="dialpad-header-num" id="dialpadMyNum"></span>
    </div>
    <button id="contactPickerBtn" class="dialpad-contact-btn hidden">üë§ –ò–∑ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤</button>
    <div id="dialDisplay" class="dial-display"><span id="dialDisplayText"></span></div>
    <div class="dial-keys">
      <button class="dial-key" data-digit="1">1</button>
      <button class="dial-key" data-digit="2">2<sub>ABC</sub></button>
      <button class="dial-key" data-digit="3">3<sub>DEF</sub></button>
      <button class="dial-key" data-digit="4">4<sub>GHI</sub></button>
      <button class="dial-key" data-digit="5">5<sub>JKL</sub></button>
      <button class="dial-key" data-digit="6">6<sub>MNO</sub></button>
      <button class="dial-key" data-digit="7">7<sub>PQRS</sub></button>
      <button class="dial-key" data-digit="8">8<sub>TUV</sub></button>
      <button class="dial-key" data-digit="9">9<sub>WXYZ</sub></button>
      <button class="dial-key" data-digit="*">*</button>
      <button class="dial-key" data-digit="0">0<sub>+</sub></button>
      <button class="dial-key" data-digit="#">#</button>
    </div>
    <div class="dialpad-actions">
      <button id="backspaceBtn" class="dialpad-action-btn">‚å´</button>
      <button id="callBtn" class="dialpad-call-btn">üìû</button>
      <button id="historyShortcutBtn" class="dialpad-action-btn">üïê</button>
    </div>
  </div>
</div>

<!-- ===== BURGER BUTTON (fixed, separate from #controls) ===== -->
<button id="burgerBtn" class="burger-btn hidden">‚ò∞</button>

<!-- ===== BURGER OVERLAY + PANEL ===== -->
<div id="burgerOverlay" class="hidden"></div>
<div id="burgerPanel" class="burger-panel">
  <div class="burger-panel-inner">
    <div class="burger-my-number-section">
      <div class="burger-section-label">–ú–æ–π –Ω–æ–º–µ—Ä</div>
      <div class="burger-my-number-row">
        <span id="panelMyNum" class="burger-my-num-text"></span>
        <button id="changeNumberBtn" class="burger-change-btn">–ò–∑–º–µ–Ω–∏—Ç—å</button>
      </div>
    </div>
    <div class="burger-section-label">–ò—Å—Ç–æ—Ä–∏—è –∑–≤–æ–Ω–∫–æ–≤</div>
    <div id="callHistoryList" class="call-history-list"></div>
    <button id="burgerClose" class="burger-close-btn">‚úï –ó–∞–∫—Ä—ã—Ç—å</button>
  </div>
</div>

<!-- ===== INCOMING CALL OVERLAY ===== -->
<div id="incomingCallOverlay" class="hidden">
  <div id="incomingCallDialog">
    <div id="incomingCallIcon">üì≤</div>
    <div id="incomingCallLabel">–í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫</div>
    <div id="incomingCallerName"></div>
    <div id="incomingCallerNumber"></div>
    <div id="incomingCallActions">
      <button id="declineCallBtn" title="–û—Ç–∫–ª–æ–Ω–∏—Ç—å">‚ùå</button>
      <button id="acceptCallBtn"  title="–ü—Ä–∏–Ω—è—Ç—å">‚úÖ</button>
    </div>
  </div>
</div>

<script src="https://browser.sentry-cdn.com/7.60.0/bundle.min.js" crossorigin="anonymous"></script>
<!-- Module entry (scaffolded). Keeps legacy video-chat.js for incremental migration. -->
<script type="module" src="src/index.js"></script>
<script src="video-chat.js"></script>
</body>
</html>
